<!DOCTYPE html>
<html lang="he" data-lang="he">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>תרומות דם - דמו / Blood donation map</title>

  <!-- Favicons -->
  <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="shortcut icon" href="favicon.ico" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        crossorigin=""/>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    body { font-size: 16px; }

    #controls{
      position:absolute; left:0; right:auto;
      z-index:1000; max-width:450px; padding:8px; background:#fff;
    }
    #lang-switcher{ text-align:left; margin-bottom:8px; }

    .info-text,
    #controls h1,
    #controls label{
      text-align:start;
    }

    #date-filter-form{ display:flex; flex-direction:row; gap:.5em; align-items:center; }
    [data-lang="he"] #date-filter-form{ flex-direction:row-reverse; }

    .leaflet-control-attribution .contact-link{ text-decoration:none; }
    .leaflet-control-attribution .contact-link:hover{ text-decoration:underline; }

    .info-text {
      margin: 1em 0;
      padding: 1em;
      background: #f8f9fa;
      border-radius: 5px;
    }

    .contact-popup {
      display: none;
      position: fixed;
      right: 16px;
      bottom: 48px;
      z-index: 2000;
      background: #fff;
      border: 1px solid #bbb;
      border-radius: 8px;
      box-shadow: 0 2px 8px #0002;
      padding: 1em 1.5em;
      min-width: 220px;
      font-size: 1em;
    }
    .contact-popup.active { display: block; }
    .contact-popup-close {
      position: absolute;
      top: 6px;
      right: 10px;
      background: none;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
      color: #888;
    }

    #toggle-controls {
      display: none;
      position: absolute;
      top: 8px;
      right: 8px;
      z-index: 1001;
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      line-height: 1;
    }
    #toggle-controls svg {
      width: 24px;
      height: 24px;
    }

    /* Медиа-запрос для мобильных устройств */
    @media (max-width: 767px) {
      /* Показываем кнопку-стрелку */
      #toggle-controls {
        display: block;
      }

      /* Скрываем текстовый блок по умолчанию */
      #controls .info-text {
        max-height: 0;
        overflow: hidden;
        padding-top: 0;
        padding-bottom: 0;
        margin-top: 0;
        margin-bottom: 0;
        transition: all 0.3s ease-in-out;
        background: none;
        border-radius: 0;
        border: none;
        box-shadow: none; 
      }

      #controls.expanded .info-text {
        max-height: 300px;
        padding: 1em;
        margin: 1em 0;
      }

      #toggle-controls .arrow-up { display: none; }
      #toggle-controls .arrow-down { display: block; }

      #controls.expanded #toggle-controls .arrow-up { display: block; }
      #controls.expanded #toggle-controls .arrow-down { display: none; }
    }

  </style>
</head>
<body>

<div id="controls">
  <!-- НОВОЕ: Кнопка для сворачивания/разворачивания -->
  <button id="toggle-controls" aria-label="Toggle info panel">
    <svg class="arrow-down" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5H7z" fill="currentColor"></path></svg>
    <svg class="arrow-up" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 15l5-5 5 5H7z" fill="currentColor"></path></svg>
  </button>

  <div id="lang-switcher">
    <button data-lang="en">En</button>
    <button data-lang="ru">Ru</button>
    <button data-lang="he">He</button>
  </div>

  <h1 data-i18n="title">תרומות דם - מפה</h1>

  <div class="info-text">
    <p data-i18n="info1">
      המפה מציגה מיקומי התרמות דם על סמך נתונים מאתר מד״א.
      לחיצה על נקודה תוביל לעמוד הרישום להתמרה באתר מד״א.
    </p>
    <p>
      <strong data-i18n="info2_strong">שימו לב:</strong>
      <span data-i18n="info2_span">
        המיקום על המפה עשוי לא להיות מדויק, יש לוודא באתר מד״א.
      </span>
    </p>
  </div>

  <form id="date-filter-form">
    <label for="date" data-i18n="date_label">הצג תרומות לתאריך:</label>
    <input type="date" id="date" name="date">
  </form>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script>
/*──────────────────────────────  словарь i18n  ─────────────────────────────*/
const i18n = {
  en:{
    title:"Blood Donations",
    info1:"The map shows blood donation locations based on data from the MDA website. Clicking on a point will lead to the registration page on the MDA site.",
    info2_strong:"Please note:&nbsp;",
    info2_span:"The location on the map may not be exact, please verify on the <a href='https://www.mdais.org/blood-donation' target='_blank'>MDA website</a>.",
    date_label:"Show donations for date:",
    register:"Register"
  },
  ru:{
    title:"Донорство крови",
    info1:"Карта показывает места сдачи крови на основе данных с сайта MDA. Нажатие на точку приведёт на страницу регистрации на сайте MDA.",
    info2_strong:"Внимание:&nbsp;",
    info2_span:"Местоположение на карте может быть неточным, пожалуйста, сверяйтесь с сайтом <a href='https://www.mdais.org/blood-donation' target='_blank'>MDA</a>.",
    date_label:"Показать сдачи на дату:",
    register:"Запись"
  },
  he:{
    title:"תרומות דם - מפה",
    info1:"המפה מציגה מיקומי התרמות דם על סמך נתונים מאתר מד\"א. לחיצה על נקודה תוביל לעמוד הרישום להתמרה באתר מד\"א.",
    info2_strong:"שימו לב:&nbsp;",
    info2_span:"המיקום על המפה עשוי לא להיות מדויק, יש לוודא באתר <a href='https://www.mdais.org/blood-donation' target='_blank'>מד\"א</a>.",
    date_label:"הצג תרומות לתאריך:",
    register:"להרשמה"
  }
};

/*───────────────────────────  надпись «Связь» в атрибуции  ─────────────────*/
const contactAttr = {
  en:'• <a href="#" id="contact-link" class="contact-link">Contact</a>',
  ru:'• <a href="#" id="contact-link" class="contact-link">Связь</a>',
  he:'• <a href="#" id="contact-link" class="contact-link">יצירת קשר</a>'
};

const API = "";                       // URL вашего backend’а
let currentLang = "he";
let lastContactAttr = contactAttr[currentLang];

/*─────────────────────────────  инициализация карты  ───────────────────────*/
const map = L.map("map",{ zoomControl:false }).setView([31.8,34.9],8);
L.control.zoom({ position:"bottomright" }).addTo(map);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
  attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

map.attributionControl.addAttribution(lastContactAttr);

const markers = L.layerGroup().addTo(map);
const dateInp = document.getElementById("date");
dateInp.valueAsDate = new Date();

/*──────────────────────────────  функции  ─────────────────────────────────*/
function applyLang(lang){
  currentLang = lang;
  const rtl = (lang === 'he');

  document.documentElement.lang = lang;
  document.documentElement.setAttribute('data-lang', lang);
  document.documentElement.dir = (lang === 'he') ? 'rtl' : 'ltr';

  const t = i18n[lang];
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const k = el.dataset.i18n;
    if (t[k]) el.innerHTML = t[k];
  });

  map.attributionControl.removeAttribution(lastContactAttr);
  lastContactAttr = contactAttr[lang];
  map.attributionControl.addAttribution(lastContactAttr);

  attachContactHandler();
}


function refresh(){
  const q = new URLSearchParams({ donation_date:dateInp.value });
  fetch(`${API}/donations?${q}`)
    .then(r=>r.json())
    .then(list=>{
      markers.clearLayers();
      list.forEach(p=>{
        const html = `
          <strong>${p.name}</strong><br>
          ${p.city} ${p.street||""} ${p.num_house||""}<br>
          ${p.from_hour}&nbsp;–&nbsp;${p.to_hour}<br>
          <a href="${p.scheduling_url}" target="_blank">${i18n[currentLang].register}</a>`;
        L.marker([p.latitude,p.longitude]).bindPopup(html).addTo(markers);
      });
    });
}

/*──────────────────────────────  события  ─────────────────────────────────*/
document.getElementById("lang-switcher").addEventListener("click", e=>{
  if(e.target.matches("button[data-lang]")){
    const lang = e.target.dataset.lang;
    if(i18n[lang]){ applyLang(lang); refresh(); }
  }
});
dateInp.addEventListener("change", refresh);

const controlsPanel = document.getElementById('controls');
const toggleButton = document.getElementById('toggle-controls');

toggleButton.addEventListener('click', () => {
  controlsPanel.classList.toggle('expanded');
});


applyLang(currentLang);
refresh();

const popup = document.createElement("div");
popup.className = "contact-popup";
popup.innerHTML = `
  <button class="contact-popup-close" title="Close">&times;</button>
  <div style="margin-bottom:0.5em"><strong>Contact</strong></div>
  <div>
    <a href="mailto:kuilef42+blood@gmail.com">kuilef42+blood@gmail.com</a><br>
    <a href="https://t.me/kuilef" target="_blank">Telegram: @kuilef</a>
  </div>
`;
document.body.appendChild(popup);

function showContactPopup() {
  popup.classList.add("active");
}
function hideContactPopup() {
  popup.classList.remove("active");
}

// Делегируем обработчик на карту, чтобы ловить появление новой ссылки
map.on("layeradd", attachContactHandler);
map.on("layerremove", attachContactHandler);
attachContactHandler();

function attachContactHandler() {
  setTimeout(()=>{
    const link = document.getElementById("contact-link");
    if(link){
      link.onclick = (e)=>{
        e.preventDefault();
        showContactPopup();
      };
    }
  }, 100);
}

popup.querySelector(".contact-popup-close").onclick = hideContactPopup;

document.addEventListener("mousedown", function(e){
  if(popup.classList.contains("active") && !popup.contains(e.target) && !e.target.classList.contains("contact-link")){
    hideContactPopup();
  }
});

</script>
</body>
</html>