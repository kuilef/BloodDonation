<!DOCTYPE html>
<html lang="he" data-lang="he">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>תרומות דם - דמו / Blood donation map</title>

  <!-- Favicons -->
  <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="shortcut icon" href="favicon.ico" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        crossorigin=""/>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    body { font-size: 16px; }

    /* боковая панель                                                         */
    #controls{
      position:absolute; left:0; right:auto;
      z-index:1000; max-width:450px; padding:8px; background:#fff;
    }
    #lang-switcher{ text-align:left; margin-bottom:8px; }

    /* RTL-правила для иврита                                                 */
    [data-lang="he"] .info-text,
    [data-lang="he"] #controls h1,
    [data-lang="he"] #controls label{
      direction:rtl; text-align:right;
    }

    /* label ↔ input                                                          */
    #date-filter-form{ display:flex; flex-direction:row; gap:.5em; align-items:center; }
    [data-lang="he"] #date-filter-form{ flex-direction:row-reverse; }

    /* лёгкий стиль ссылки в атрибуции                                        */
    .leaflet-control-attribution .contact-link{ text-decoration:none; }
    .leaflet-control-attribution .contact-link:hover{ text-decoration:underline; }
  </style>
</head>
<body>

<div id="controls">
  <div id="lang-switcher">
    <button data-lang="en">En</button>
    <button data-lang="ru">Ru</button>
    <button data-lang="he">He</button>
  </div>

  <h1 data-i18n="title">תרומות דם - מפה</h1>

  <div class="info-text" style="margin:1em 0;padding:1em;background:#f8f9fa;border-radius:5px;">
    <p data-i18n="info1">
      המפה מציגה מיקומי התרמות דם על סמך נתונים מאתר מד״א.
      לחיצה על נקודה תוביל לעמוד הרישום להתמרה באתר מד״א.
    </p>
    <p>
      <strong data-i18n="info2_strong">שימו לב:</strong>
      <span data-i18n="info2_span">
        המיקום על המפה עשוי לא להיות מדויק, יש לוודא באתר מד״א.
      </span>
    </p>
  </div>

  <form id="date-filter-form">
    <label for="date" data-i18n="date_label">הצג תרומות לתאריך:</label>
    <input type="date" id="date" name="date">
  </form>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script>
/*──────────────────────────────  словарь i18n  ─────────────────────────────*/
const i18n = {
  en:{
    title:"Blood Donations - Map",
    info1:"The map shows blood donation locations based on data from the MDA website. Clicking on a point will lead to the registration page on the MDA site.",
    info2_strong:"Please note:",
    info2_span:"The location on the map may not be exact, please verify on the <a href='https://www.mdais.org/blood-donation' target='_blank'>MDA website</a>.",
    date_label:"Show donations for date:",
    register:"Register"
  },
  ru:{
    title:"Донорство крови - Карта",
    info1:"Карта показывает места сдачи крови на основе данных с сайта MDA. Нажатие на точку приведёт на страницу регистрации на сайте MDA.",
    info2_strong:"Внимание:",
    info2_span:"Местоположение на карте может быть неточным, пожалуйста, сверяйтесь с сайтом <a href='https://www.mdais.org/blood-donation' target='_blank'>MDA</a>.",
    date_label:"Показать сдачи на дату:",
    register:"Запись"
  },
  he:{
    title:"תרומות דם - מפה",
    info1:"המפה מציגה מיקומי התרמות דם על סמך נתונים מאתר מד\"א. לחיצה על נקודה תוביל לעמוד הרישום להתמרה באתר מד\"א.",
    info2_strong:"שימו לב:",
    info2_span:"המיקום על המפה עשוי לא להיות מדויק, יש לוודא באתר <a href='https://www.mdais.org/blood-donation' target='_blank'>מד\"א</a>.",
    date_label:"הצג תרומות לתאריך:",
    register:"להרשמה"
  }
};

/*───────────────────────────  надпись «Связь» в атрибуции  ─────────────────*/
const contactAttr = {
  en:'• <a href="mailto:kuilef42+blood@gmail.com" class="contact-link">Contact</a>',
  ru:'• <a href="mailto:kuilef42+blood@gmail.com" class="contact-link">Связь</a>',
  he:'• <a href="mailto:kuilef42+blood@gmail.com" class="contact-link">יצירת קשר</a>'
};

const API = "/";                       // URL вашего backend’а
let currentLang = "he";
let lastContactAttr = contactAttr[currentLang];

/*─────────────────────────────  инициализация карты  ───────────────────────*/
const map = L.map("map",{ zoomControl:false }).setView([31.8,34.9],8);
L.control.zoom({ position:"bottomright" }).addTo(map);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
  attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

/* добавляем контактную ссылку к атрибуции */
map.attributionControl.addAttribution(lastContactAttr);

const markers = L.layerGroup().addTo(map);
const dateInp = document.getElementById("date");
dateInp.valueAsDate = new Date();

/*──────────────────────────────  функции  ─────────────────────────────────*/
function applyLang(lang){
  currentLang = lang;
  document.documentElement.lang = lang;
  document.documentElement.setAttribute("data-lang", lang);

  /* переводим все элементы */
  const t = i18n[lang];
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const k = el.dataset.i18n;
    if(t[k]) el.innerHTML = t[k];
  });

  /* заменяем контакт в атрибуции */
  map.attributionControl.removeAttribution(lastContactAttr);
  lastContactAttr = contactAttr[lang];
  map.attributionControl.addAttribution(lastContactAttr);
}

function refresh(){
  if(!API) return;               // уберите проверку, если API обязателен
  const q = new URLSearchParams({ donation_date:dateInp.value });
  fetch(`${API}/donations?${q}`)
    .then(r=>r.json())
    .then(list=>{
      markers.clearLayers();
      list.forEach(p=>{
        const html = `
          <strong>${p.name}</strong><br>
          ${p.city} ${p.street||""} ${p.num_house||""}<br>
          ${p.from_hour}&nbsp;–&nbsp;${p.to_hour}<br>
          <a href="${p.scheduling_url}" target="_blank">${i18n[currentLang].register}</a>`;
        L.marker([p.latitude,p.longitude]).bindPopup(html).addTo(markers);
      });
    });
}

/*──────────────────────────────  события  ─────────────────────────────────*/
document.getElementById("lang-switcher").addEventListener("click", e=>{
  if(e.target.matches("button[data-lang]")){
    const lang = e.target.dataset.lang;
    if(i18n[lang]){ applyLang(lang); refresh(); }
  }
});
dateInp.addEventListener("change", refresh);

/*──────────────────────────────  запуск  ─────────────────────────────────*/
applyLang(currentLang);
refresh();                          /* запрос к API */
</script>
</body>
</html>

